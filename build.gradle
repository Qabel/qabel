apply plugin: 'java'
apply plugin: 'eclipse'

repositories {
    mavenCentral()
}

dependencies {
}

class ExecWait extends DefaultTask {
	String command
	String ready
	String directory

	@TaskAction
	def spawnProcess() {

		ProcessBuilder builder = new ProcessBuilder(command.split(' '))
		builder.redirectErrorStream(true)
		builder.directory(new File(directory))
		builder.redirectOutput(new File("./log/"+directory+".log"));

		Process process = builder.start()

		InputStream stdout = process.getInputStream()
		BufferedReader reader = new BufferedReader(new InputStreamReader(stdout))
	}
}

task killAllTestProcesses {
    def ports = [6000, 8000]
 
    ports.each { port ->
        def cmd = "lsof -Fp -i :$port"
        def process = cmd.execute()
        process.in.eachLine { line ->
        	def command = "kill -9 "+line.substring(1)
        	def killProcess = command.execute()
            killProcess.waitFor()
        }
    }
}


task startDropServer(type: ExecWait) {
	command 'python drop_server.py &'
	ready 'Drop server running.'
	directory './qabel-drop'
}

task getNodeModules(type: ExecWait) {
	command 'npm install'
	ready 'Storage server modules initialised.'
	directory './qabel-storage'
}

task checkStorage {
	File dataFolder = new File("./qabel-storage/data/");
	if( !dataFolder.exists() ) {
		dataFolder.mkdirs();
	}
	File nodeModulesFolder = new File("./qabel-storage/node_modules/");
	if( !nodeModulesFolder.exists() ) {
		getNodeModules.execute()
	}
}

task startStorageServer(type: ExecWait) {
	dependsOn checkStorage	
	command 'nodejs app.js &'
	ready 'Storage server running.'
	directory './qabel-storage'
}

task startServers {
	File logFolder = new File("./log/");
	if( !logFolder.exists() ) {
		logFolder.mkdirs();
	}
	startDropServer.execute()
	startStorageServer.execute()
}

gradle.addListener new TestLifecycleListener()
 
class TestLifecycleListener implements TaskExecutionListener {

    @Override
    void beforeExecute(Task task) {
        if (task.name == 'test') {
              task.project.rootProject.startServers.execute();
        }
    }
 
    @Override
    void afterExecute(Task task, TaskState taskState) {
        if (task.name == 'test') {
           task.project.rootProject.killAllTestProcesses.execute()
        }
    }
}




test {

}


task wrapper(type: Wrapper) {
    gradleVersion = '2.2.1'
}

